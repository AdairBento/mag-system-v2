name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  lint:
    name: ğŸ§¹ Lint
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ’» Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Run ESLint
        run: pnpm lint

  type-check:
    name: ğŸ“¦ Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ’» Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”µ Generate Prisma Client
        run: pnpm --filter @mag-system/database prisma generate

      - name: ğŸ“˜ TypeScript Check
        run: pnpm type-check || echo "Add type-check script to package.json"

  test:
    name: ğŸ§ª Test & Coverage
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ’» Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”µ Generate Prisma Client
        run: pnpm --filter @mag-system/database prisma generate

      - name: ğŸ§ª Run tests with coverage
        run: pnpm test:cov

      - name: ğŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/api/coverage/lcov.info
          flags: api
          name: api-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build:
    name: ğŸ› ï¸ Build
    runs-on: ubuntu-latest
    needs: [lint, type-check, test]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ’» Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”µ Generate Prisma Client
        run: pnpm --filter @mag-system/database prisma generate

      - name: ğŸ“¦ Build all packages
        run: pnpm build

      - name: âœ… Build successful
        run: echo "All builds completed successfully!"

  quality-gate:
    name: ğŸ† Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, type-check, test, build]
    if: always()
    steps:
      - name: âœ… All checks passed
        if: ${{ needs.lint.result == 'success' && needs.type-check.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success' }}
        run: |
          echo "âœ… Quality Gate PASSED"
          echo "All jobs completed successfully!"

      - name: âŒ Quality gate failed
        if: ${{ needs.lint.result != 'success' || needs.type-check.result != 'success' || needs.test.result != 'success' || needs.build.result != 'success' }}
        run: |
          echo "âŒ Quality Gate FAILED"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Type Check: ${{ needs.type-check.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Build: ${{ needs.build.result }}"
          exit 1
