# ================================
# Base - Debian Bookworm Slim
# ================================
FROM node:20-bookworm-slim AS base
WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    openssl \
    wget \
  && rm -rf /var/lib/apt/lists/*

RUN corepack enable && corepack prepare pnpm@8.15.9 --activate

# ================================
# Build - Compila√ß√£o
# ================================
FROM base AS build

# üî• FOR√áAR development mode (garante devDependencies)
ENV NODE_ENV=development

# Copiar arquivos de configura√ß√£o (melhor cache)
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY tsconfig.base.json ./

# üêû FIX: Usar .npmrc espec√≠fico para Docker (evita symlinks quebrados do Windows)
COPY .npmrc.docker .npmrc

# Copiar package.json dos workspaces (TODOS os packages usados)
COPY apps/api/package.json ./apps/api/
COPY packages/core/package.json ./packages/core/
COPY packages/database/package.json ./packages/database/
COPY packages/shared-types/package.json ./packages/shared-types/

# Instalar TODAS depend√™ncias (NODE_ENV=development j√° garante devDeps)
RUN pnpm install --frozen-lockfile

# üîç DEBUG: Verificar se Prisma foi instalado
RUN echo "\n=== DEBUG: NODE_ENV ==="
RUN node -p "process.env.NODE_ENV"
RUN echo "\n=== DEBUG: Prisma binary location ==="
RUN ls -la /app/packages/database/node_modules/prisma/build/ 2>&1 || echo "‚ùå packages/database/node_modules/prisma NOT found"
RUN ls -la /app/node_modules/.pnpm/prisma*/node_modules/prisma/build/ 2>&1 | head -5 || echo "‚ùå .pnpm prisma NOT found"
RUN echo "\n=== END PRISMA DEBUG ===\n"

# Copiar c√≥digo fonte completo
COPY . .

# Gerar Prisma Client usando npx (resolve bin√°rios automaticamente)
RUN npx prisma generate --schema=packages/database/prisma/schema.prisma

# üîç DEBUG: Verificar depend√™ncias do core ANTES do build
RUN echo "\n=== DEBUG: Core dependencies check ==="
RUN echo "Checking packages/core/node_modules:"
RUN ls -la /app/packages/core/node_modules/ 2>&1 | head -10 || echo "‚ùå packages/core/node_modules NOT found"
RUN echo "\nChecking if class-validator is installed:"
RUN test -d /app/packages/core/node_modules/class-validator && echo "‚úÖ class-validator found" || echo "‚ùå class-validator NOT found"
RUN test -d /app/node_modules/.pnpm/node_modules/class-validator && echo "‚úÖ class-validator in .pnpm" || echo "‚ùå class-validator NOT in .pnpm"
RUN echo "\nChecking if zod is installed:"
RUN test -d /app/packages/core/node_modules/zod && echo "‚úÖ zod found" || echo "‚ùå zod NOT found"
RUN test -d /app/node_modules/.pnpm/node_modules/zod && echo "‚úÖ zod in .pnpm" || echo "‚ùå zod NOT in .pnpm"
RUN echo "\nChecking if date-fns is installed:"
RUN test -d /app/packages/core/node_modules/date-fns && echo "‚úÖ date-fns found" || echo "‚ùå date-fns NOT found"
RUN test -d /app/node_modules/.pnpm/node_modules/date-fns && echo "‚úÖ date-fns in .pnpm" || echo "‚ùå date-fns NOT in .pnpm"
RUN echo "\n=== END CORE DEPS DEBUG ===\n"

# Build EXPL√çCITO das depend√™ncias (ordem correta)
RUN pnpm --filter @mag-system/shared-types build
RUN pnpm --filter @mag-system/database build
RUN pnpm --filter @mag-system/core build

# ================================
# üîç DEBUG: Verificar workspace links ANTES do nest build
# ================================
RUN echo "\n=== DEBUG: Checking @mag-system/core resolution ==="
RUN node -p "require.resolve('@mag-system/core/package.json')" || echo "‚ùå FAIL: core NOT resolvable"
RUN echo "\n=== DEBUG: Core package.json ==="
RUN node -p "JSON.stringify(require('@mag-system/core/package.json'), null, 2)" || echo "‚ùå FAIL: can't read core package.json"
RUN echo "\n=== DEBUG: node_modules/@mag-system structure ==="
RUN ls -la node_modules/@mag-system/ || echo "‚ùå FAIL: @mag-system not found"
RUN echo "\n=== DEBUG: node_modules/@mag-system/core ==="
RUN ls -la node_modules/@mag-system/core/ || echo "‚ùå FAIL: core not found"
RUN echo "\n=== DEBUG: packages/core/dist ==="
RUN ls -la packages/core/dist/ || echo "‚ùå FAIL: packages/core/dist not found"
RUN echo "\n=== DEBUG: Check if dist/index.d.ts exists ==="
RUN test -f packages/core/dist/index.d.ts && echo "‚úÖ OK: index.d.ts exists" || echo "‚ùå FAIL: index.d.ts NOT found"
RUN echo "\n=== END DEBUG ===\n"

# Build da API com cadeia topol√≥gica
RUN pnpm --filter @mag-system/api... build

# Deploy production bundle isolado
RUN pnpm --filter @mag-system/api deploy --prod /out

# Sanity checks - garantem que bundle est√° correto
RUN test -f /out/dist/main.js || (echo "ERROR: /out/dist/main.js not found!" && exit 1)
RUN test -f /out/node_modules/@mag-system/database/dist/index.js || (echo "ERROR: database dist missing in bundle!" && exit 1)

# ================================
# Runtime - Produ√ß√£o
# ================================
FROM node:20-bookworm-slim AS runtime
WORKDIR /app
ENV NODE_ENV=production

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    openssl \
    wget \
  && rm -rf /var/lib/apt/lists/*

# Copiar bundle completo (node_modules prod + dist + Prisma Client)
COPY --from=build /out/ ./

# Criar usu√°rio n√£o-root
RUN groupadd -r nodejs && useradd -r -g nodejs nodejs && \
    chown -R nodejs:nodejs /app

USER nodejs

EXPOSE 3001

# Healthcheck
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3001/api/health || exit 1

CMD ["node", "dist/main.js"]
