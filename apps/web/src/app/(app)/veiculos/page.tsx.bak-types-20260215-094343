"use client"
import { useState } from 'react'
import { Plus, Car, Search, Edit, Trash2, AlertCircle } from 'lucide-react'
import { useVehicles, useCreateVehicle, useUpdateVehicle, useDeleteVehicle } from '@/lib/hooks/use-vehicles'
import { useDebounce } from '@/lib/hooks/use-debounce'
import { VehicleCard } from './_components/vehicle-card'
import { VehicleFormModal } from './_components/vehicle-form-modal'
import type { Vehicle, VehicleStatus, VehicleCategory, CreateVehicleDto } from '@/types/vehicle'

export default function VehiclesPage() {
  const [search, setSearch] = useState('')
  const debouncedSearch = useDebounce(search, 500)
  
  const [statusFilter, setStatusFilter] = useState<VehicleStatus | 'all'>('all')
  const [categoryFilter, setCategoryFilter] = useState<VehicleCategory | 'all'>('all')
  const [page, setPage] = useState(1)
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [editingVehicle, setEditingVehicle] = useState<Vehicle | null>(null)

  const filters = {
    search: debouncedSearch || undefined,
    status: statusFilter !== 'all' ? statusFilter : undefined,
    category: categoryFilter !== 'all' ? categoryFilter : undefined,
    page,
    limit: 12
  }

  const { data, isLoading, error } = useVehicles(filters)
  const createMutation = useCreateVehicle()
  const updateMutation = useUpdateVehicle()
  const deleteMutation = useDeleteVehicle()

  const handleSubmit = (formData: CreateVehicleDto) => {
    if (editingVehicle) {
      updateMutation.mutate({ id: editingVehicle.id, data: formData }, {
        onSuccess: () => {
          setIsModalOpen(false)
          setEditingVehicle(null)
        }
      })
    } else {
      createMutation.mutate(formData, {
        onSuccess: () => {
          setIsModalOpen(false)
        }
      })
    }
  }

  const handleEdit = (vehicle: Vehicle) => {
    setEditingVehicle(vehicle)
    setIsModalOpen(true)
  }

  const handleDelete = (vehicle: Vehicle) => {
    if (confirm(`Remover ${vehicle.brand} ${vehicle.model} (${vehicle.plate})?`)) {
      deleteMutation.mutate(vehicle.id)
    }
  }

  const handleNewVehicle = () => {
    setEditingVehicle(null)
    setIsModalOpen(true)
  }

  const totalPages = Math.ceil((data?.total || 0) / 12)

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Car className="w-6 h-6 text-teal-600" />
          <h1 className="text-2xl font-bold">Veículos</h1>
          <span className="text-slate-500">({data?.total || 0})</span>
        </div>
        <button
          onClick={handleNewVehicle}
          className="flex items-center gap-2 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition"
        >
          <Plus className="w-4 h-4" />
          Novo Veículo
        </button>
      </div>

      {/* Filters */}
      <div className="flex gap-3">
        <div className="relative flex-1">
          <Search className="w-4 h-4 absolute left-3 top-3 text-slate-400" />
          <input
            value={search}
            onChange={(e) => { setSearch(e.target.value); setPage(1) }}
            className="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-200"
            placeholder="Buscar por placa, marca ou modelo..."
          />
        </div>
        <select
          value={statusFilter}
          onChange={(e) => { setStatusFilter(e.target.value as "all" | "AVAILABLE" | "RENTED" | "MAINTENANCE" | "INACTIVE"); setPage(1) }}
          className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-200"
        >
          <option value="all">Status: Todos</option>
          <option value="AVAILABLE">Disponível</option>
          <option value="RENTED">Alugado</option>
          <option value="MAINTENANCE">Manutenção</option>
          <option value="INACTIVE">Inativo</option>
        </select>
        <select
          value={categoryFilter}
          onChange={(e) => { setCategoryFilter(e.target.value as "all" | "ECONOMIC" | "INTERMEDIATE" | "EXECUTIVE" | "SUV"); setPage(1) }}
          className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-200"
        >
          <option value="all">Categoria: Todas</option>
          <option value="ECONOMIC">Econômico</option>
          <option value="INTERMEDIATE">Intermediário</option>
          <option value="EXECUTIVE">Executivo</option>
          <option value="SUV">SUV</option>
        </select>
      </div>

      {/* Error */}
      {error && (
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-3">
          <AlertCircle className="w-5 h-5 text-red-600" />
          <p className="text-red-700">Erro ao carregar veículos. Tente novamente.</p>
        </div>
      )}

      {/* Loading */}
      {isLoading && <p className="text-slate-500 text-center py-12">Carregando veículos...</p>}

      {/* Grid */}
      {!isLoading && !error && data?.items && (
        <>
          <div className="grid md:grid-cols-3 lg:grid-cols-4 gap-6">
            {data.items.map((vehicle) => (
              <div key={vehicle.id} className="relative group">
                <VehicleCard vehicle={vehicle} />
                <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                  <button
                    onClick={() => handleEdit(vehicle)}
                    className="p-2 bg-white rounded-lg shadow hover:bg-teal-50 transition"
                    title="Editar"
                  >
                    <Edit className="w-4 h-4 text-teal-600" />
                  </button>
                  <button
                    onClick={() => handleDelete(vehicle)}
                    className="p-2 bg-white rounded-lg shadow hover:bg-red-50 transition"
                    title="Excluir"
                  >
                    <Trash2 className="w-4 h-4 text-red-600" />
                  </button>
                </div>
              </div>
            ))}
          </div>

          {/* Pagination */}
          {totalPages > 1 && (
            <div className="flex justify-center items-center gap-2">
              <button
                onClick={() => setPage(p => Math.max(1, p - 1))}
                disabled={page === 1}
                className="px-4 py-2 border rounded-lg disabled:opacity-50 hover:bg-slate-50 transition"
              >
                Anterior
              </button>
              <span className="px-4 py-2 text-sm">
                Página <strong>{page}</strong> de <strong>{totalPages}</strong>
              </span>
              <button
                onClick={() => setPage(p => Math.min(totalPages, p + 1))}
                disabled={page === totalPages}
                className="px-4 py-2 border rounded-lg disabled:opacity-50 hover:bg-slate-50 transition"
              >
                Próxima
              </button>
            </div>
          )}
        </>
      )}

      {/* Empty */}
      {!isLoading && !error && data?.items?.length === 0 && (
        <div className="text-center py-12">
          <Car className="w-16 h-16 mx-auto text-slate-300 mb-4" />
          <p className="text-slate-400 text-lg">Nenhum veículo encontrado</p>
          {(search || statusFilter !== 'all' || categoryFilter !== 'all') && (
            <p className="text-slate-400 text-sm mt-2">Tente ajustar os filtros</p>
          )}
        </div>
      )}

      {/* Modal */}
      <VehicleFormModal
        isOpen={isModalOpen}
        vehicle={editingVehicle}
        onClose={() => { setIsModalOpen(false); setEditingVehicle(null) }}
        onSubmit={handleSubmit}
      />
    </div>
  )
}
